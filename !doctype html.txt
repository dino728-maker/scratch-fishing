<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é‡£ã‚Šã‚¹ã‚¯ãƒ©ãƒƒãƒå¯¾æˆ¦ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼ˆå…¨éƒ¨å…¥ã‚Šï¼‰</title>
  <style>
    :root { --gap: 12px; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin: 0; background: #f6f7f9; color:#111; }
    header { padding: 16px; background:#111; color:#fff; }
    header h1 { font-size: 18px; margin: 0; }
    main { padding: 16px; max-width: 1120px; margin: 0 auto; }
    .grid { display:grid; grid-template-columns: 1fr; gap: var(--gap); }
    @media (min-width: 980px){ .grid { grid-template-columns: 1.25fr 0.75fr; } }
    .card { background:#fff; border-radius: 16px; padding: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    .row { display:flex; gap: var(--gap); flex-wrap: wrap; align-items: end; }
    label { font-size: 12px; color:#444; display:block; margin-bottom:6px; }
    input, select, button, textarea { font: inherit; }
    input[type="number"], input[type="text"], select, textarea {
      width: 100%; padding: 12px; border: 1px solid #d7dbe2; border-radius: 12px; background:#fff;
    }
    textarea { min-height: 130px; }
    .field { flex: 1 1 160px; }
    .btn { padding: 12px 14px; border: 0; border-radius: 12px; cursor: pointer; background:#111; color:#fff; }
    .btn:active { transform: translateY(1px); }
    .btn.sub { background:#4b5563; }
    .btn.danger { background:#b91c1c; }
    .btn.good { background:#047857; }
    .btn.warn { background:#a16207; }
    .pill { display:inline-flex; gap:8px; align-items:center; padding: 10px 12px; border-radius: 999px; background:#f0f2f6; }
    .pill input { width:auto; }
    .muted { color:#6b7280; font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .stat { display:grid; grid-template-columns: repeat(2,1fr); gap: 10px; }
    .stat div { background:#f6f7f9; border-radius: 12px; padding: 10px; }
    .stat .big { font-size: 20px; font-weight: 800; }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding: 10px 8px; border-bottom: 1px solid #eef1f5; font-size: 14px; vertical-align: top; }
    th { color:#555; font-weight: 700; }
    .badge { display:inline-block; padding: 2px 8px; border-radius: 999px; background:#f0f2f6; font-size: 12px; }
    dialog { border: none; border-radius: 16px; width: min(520px, 92vw); box-shadow: 0 18px 50px rgba(0,0,0,.25); }
    dialog::backdrop { background: rgba(0,0,0,.35); }
    .dlg-title { font-weight: 800; margin: 0 0 8px 0; }
    .dlg-body { padding: 16px; }
    .dlg-actions { display:flex; gap: 10px; justify-content: flex-end; padding: 0 16px 16px; }
    .right { text-align: right; }
  </style>
</head>
<body>
<header>
  <h1>é‡£ã‚Šã‚¹ã‚¯ãƒ©ãƒƒãƒå¯¾æˆ¦ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼ˆå…¨éƒ¨å…¥ã‚Šï¼‰</h1>
</header>

<main>
  <div class="grid">

    <!-- Input -->
    <section class="card">
      <h2 style="margin:0 0 10px 0; font-size:16px;">è¨˜éŒ²ã™ã‚‹</h2>

      <div class="row">
        <div class="field">
          <label>èª°ãŒé‡£ã£ãŸï¼Ÿ</label>
          <select id="who"></select>
        </div>

        <div class="field">
          <label>ã‚µã‚¤ã‚ºï¼ˆcmï¼‰</label>
          <input id="cm" type="number" inputmode="decimal" min="0" step="0.1" placeholder="ä¾‹ï¼š28.5" />
        </div>

        <div class="field">
          <label>é­šç¨®ï¼ˆå€ç‡ï¼‰</label>
          <select id="species"></select>
        </div>

        <div class="field" style="flex: 2 1 240px;">
          <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
          <input id="memo" type="text" placeholder="ä¾‹ï¼šè¡¨å±¤ãƒ»è¿½ã„é¢¨ãƒ»ãƒ–ãƒ«ãƒ”ãƒ³ ãªã©" />
        </div>

        <div class="field" style="flex: 0 0 160px;">
          <button class="btn" id="addBtn">è¿½åŠ </button>
        </div>
      </div>

      <div style="margin-top: 12px;" class="row">
        <span class="pill"><input id="bonusFirst" type="checkbox" /> <label for="bonusFirst" style="margin:0;">å…ˆåˆ¶ãƒœãƒ¼ãƒŠã‚¹ï¼ˆæœ€åˆã®1åŒ¹ +1æšï¼‰</label></span>
        <span class="pill"><input id="bonusGirl" type="checkbox" /> <label for="bonusGirl" style="margin:0;">å¥³æ€§ãƒœãƒ¼ãƒŠã‚¹ï¼ˆå¥³æ€§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ +1æšï¼‰</label></span>
        <span class="pill"><input id="bonusFunny" type="checkbox" /> <label for="bonusFunny" style="margin:0;">å¤–é“ãƒœãƒ¼ãƒŠã‚¹æœ‰åŠ¹ï¼ˆâ€œç¬‘ãˆãŸã‚‰+1â€ï¼‰</label></span>
      </div>

      <div style="margin-top: 12px;" class="row">
        <button class="btn warn" id="funnyBtn" title="ã‚µã‚¤ã‚ºå…¥åŠ›ãªã—ã§ã‚‚è¿½åŠ ã§ãã‚‹">ğŸ¤£ ç¬‘ãˆãŸå¤–é“ +1</button>
        <button class="btn sub" id="manualBtn" title="ä»»æ„ã®æšæ•°ã‚’ç›´æ¥åŠ ç®—">â• æ‰‹å‹•ã§æšæ•°ã‚’åŠ ç®—</button>
      </div>

      <p class="muted" style="margin: 10px 0 0;">
        â€»ãƒ‡ãƒ¼ã‚¿ã¯ç«¯æœ«ã«ä¿å­˜ï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼‰ã€‚ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã§ã‚¢ãƒ—ãƒªã£ã½ãä½¿ãˆã¾ã™ã€‚
      </p>
    </section>

    <!-- Scoreboard -->
    <aside class="card">
      <h2 style="margin:0 0 10px 0; font-size:16px;">ç¾åœ¨ã®åˆè¨ˆ</h2>
      <div class="stat" id="scoreGrid"></div>

      <div style="margin-top:12px;" class="row">
        <button class="btn sub" id="undoBtn">å–ã‚Šæ¶ˆã—</button>
        <button class="btn danger" id="clearBtn">å…¨æ¶ˆã—</button>
      </div>

      <hr style="border:0; border-top:1px solid #eef1f5; margin:14px 0;">

      <h3 style="margin:0 0 8px 0; font-size:14px;">å½“ãŸã‚ŠãŒå‡ºãŸã‚‰â€¦ï¼ˆã”é£¯ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆï¼‰</h3>
      <div class="row">
        <button class="btn good" id="rouletteBtn">ğŸš å›ã™</button>
        <button class="btn sub" id="editRouletteBtn">ç·¨é›†</button>
      </div>
      <p class="muted" style="margin:8px 0 0;">ã‚¹ã‚¯ãƒ©ãƒƒãƒå½“ãŸã‚ŠãŒå‡ºãŸã‚‰æŠ¼ã—ã¦ã­ã€‚ã‚‚ã¡ã‚ã‚“å¤–ã‚Œã¦ã‚‚æŠ¼ã—ã¦ã„ã„ï¼ˆäººç”Ÿã¯è‡ªç”±ï¼‰ã€‚</p>
    </aside>

    <!-- Log -->
    <section class="card" style="grid-column: 1 / -1;">
      <h2 style="margin:0 0 10px 0; font-size:16px;">å±¥æ­´</h2>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>æ™‚åˆ»</th>
              <th>èª°</th>
              <th>ã‚µã‚¤ã‚º</th>
              <th>é­šç¨®</th>
              <th>ãƒ¡ãƒ¢</th>
              <th>æšæ•°</th>
              <th class="muted">å†…è¨³</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="log"></tbody>
        </table>
      </div>
      <p class="muted" style="margin: 8px 0 0;">â€»ã€Œâœï¸ã€ã§ãã®1ä»¶ã ã‘ç·¨é›†ã§ãã¾ã™ã€‚</p>
    </section>

    <!-- Settings -->
    <section class="card" style="grid-column: 1 / -1;">
      <h2 style="margin:0 0 10px 0; font-size:16px;">è¨­å®šï¼ˆå…¨éƒ¨ã“ã“ã§ã„ã˜ã‚Œã‚‹ï¼‰</h2>

      <div class="row">
        <div class="field">
          <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆ1è¡Œ=åå‰,æ€§åˆ¥ï¼‰ ä¾‹ï¼šæ¾å³¶,m / æ—©å¦ƒå­,f</label>
          <textarea id="players"></textarea>
          <div class="row" style="margin-top:10px;">
            <button class="btn" id="savePlayersBtn">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¿å­˜</button>
            <button class="btn sub" id="resetPlayersBtn">åˆæœŸã«æˆ»ã™</button>
          </div>
        </div>

        <div class="field">
          <label>ã‚µã‚¤ã‚ºâ†’æšæ•°ï¼ˆ1è¡Œ=cm,æšæ•°ï¼‰</label>
          <textarea id="rules"></textarea>
          <p class="muted" style="margin:8px 0 0;">
            ã‚µã‚¤ã‚ºä»¥ä¸Šã§ãã®æšæ•°ï¼ˆå¤§ãã„æ¡ä»¶ãŒå„ªå…ˆï¼‰ã€‚ä¾‹ï¼š<span class="mono">30,3</span>
          </p>
          <div class="row" style="margin-top:10px;">
            <button class="btn" id="saveRulesBtn">ãƒ«ãƒ¼ãƒ«ä¿å­˜</button>
            <button class="btn sub" id="resetRulesBtn">åˆæœŸã«æˆ»ã™</button>
          </div>
        </div>

        <div class="field">
          <label>é­šç¨®å€ç‡ï¼ˆ1è¡Œ=è¡¨ç¤ºå,å€ç‡ï¼‰ ä¾‹ï¼šé’ç‰©,1.2</label>
          <textarea id="speciesRules"></textarea>
          <p class="muted" style="margin:8px 0 0;">
            åŸºæœ¬æšæ•°Ã—å€ç‡ã‚’å››æ¨äº”å…¥ã€‚ä¾‹ï¼š3æšÃ—1.2=4æšï¼ˆæ°—æŒã¡ãŒå¤§äº‹ï¼‰
          </p>
          <div class="row" style="margin-top:10px;">
            <button class="btn" id="saveSpeciesBtn">å€ç‡ä¿å­˜</button>
            <button class="btn sub" id="resetSpeciesBtn">åˆæœŸã«æˆ»ã™</button>
          </div>
        </div>
      </div>
    </section>

  </div>
</main>

<!-- Dialogs -->
<dialog id="dlg">
  <div class="dlg-body">
    <h3 class="dlg-title" id="dlgTitle">Dialog</h3>
    <div id="dlgContent"></div>
  </div>
  <div class="dlg-actions" id="dlgActions"></div>
</dialog>

<script>
  const STORAGE_KEY = "scratchFishing_allin_v2";

  // ---- Defaults ----
  const defaultPlayers = [
    { name: "æ¾å³¶", gender: "m" },
    { name: "æ—©å¦ƒå­", gender: "f" },
  ];

  const defaultRules = [
    { cm: 20, tickets: 1 },
    { cm: 25, tickets: 2 },
    { cm: 30, tickets: 3 },
    { cm: 35, tickets: 5 },
    { cm: 40, tickets: 7 },
  ];

  const defaultSpecies = [
    { name: "æŒ‡å®šãªã—", mult: 1.0 },
    { name: "ã‚¢ã‚¸ãƒ»ãƒ¡ãƒãƒ«ç³»", mult: 1.0 },
    { name: "ãƒ•ãƒ©ãƒƒãƒˆï¼ˆãƒ’ãƒ©ãƒ¡/ãƒã‚´ãƒï¼‰", mult: 1.15 },
    { name: "é’ç‰©ï¼ˆãƒ¤ã‚º/ã‚µã‚´ã‚·ç­‰ï¼‰", mult: 1.20 },
    { name: "çœŸé¯›ãƒ»æ ¹é­š", mult: 1.10 },
    { name: "å¤–é“ï¼ˆãƒ•ã‚°/ã‚¨ã‚½ç­‰ï¼‰", mult: 0.80 },
  ];

  const defaultRoulette = [
    "ç„¼è‚‰",
    "å¯¿å¸",
    "ãƒ©ãƒ¼ãƒ¡ãƒ³ï¼ˆæ›¿ãˆç‰ã¯æ­£ç¾©ï¼‰",
    "ã†ã©ã‚“ï¼ˆç¦å²¡ã®èª‡ã‚Šï¼‰",
    "æµ·é®®ä¸¼",
    "é¤ƒå­ï¼‹ãƒ“ãƒ¼ãƒ«ï¼ˆå¤§äººã®å‹åˆ©ï¼‰",
    "ã‚³ãƒ³ãƒ“ãƒ‹ã§å¥½ããªã ã‘ï¼ˆç¥­ã‚Šï¼‰",
    "å®¶ã§é‹ï¼ˆå„ªå‹ï¼‰",
    "å”æšã’å®šé£Ÿ",
    "ã‚«ãƒ¬ãƒ¼ï¼ˆãªãœã‹æ¯å›ã†ã¾ã„ï¼‰",
  ];

  // ---- State ----
  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) throw new Error("no state");
      const s = JSON.parse(raw);
      // guards
      if (!Array.isArray(s.players) || !Array.isArray(s.rules) || !Array.isArray(s.species) || !Array.isArray(s.log)) {
        throw new Error("bad state");
      }
      return s;
    } catch {
      return {
        players: defaultPlayers,
        rules: defaultRules,
        species: defaultSpecies,
        roulette: defaultRoulette,
        log: [],
        bonusFirst: true,
        bonusGirl: true,
        bonusFunny: true,
      };
    }
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  let state = loadState();

  // ---- Helpers ----
  function nowText() {
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
  }

  function escapeHtml(s) {
    return (s ?? "").toString().replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[c]));
  }

  function rulesToText(rules) {
    return rules.slice().sort((a,b)=>a.cm-b.cm).map(r => `${r.cm},${r.tickets}`).join("\n");
  }
  function parseRules(text) {
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    const out = [];
    for (const line of lines) {
      const [a,b] = line.split(",").map(x=>x.trim());
      const cm = Number(a), tickets = Number(b);
      if (Number.isFinite(cm) && Number.isFinite(tickets)) out.push({ cm, tickets });
    }
    out.sort((a,b)=>a.cm-b.cm);
    return out.length ? out : defaultRules;
  }

  function playersToText(players) {
    return players.map(p => `${p.name},${p.gender}`).join("\n");
  }
  function parsePlayers(text) {
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    const out = [];
    for (const line of lines) {
      const [name, genderRaw] = line.split(",").map(x=>x.trim());
      const gender = (genderRaw || "m").toLowerCase();
      if (!name) continue;
      out.push({ name, gender: (gender === "f" ? "f" : "m") });
    }
    return out.length ? out : defaultPlayers;
  }

  function speciesToText(list) {
    return list.map(s => `${s.name},${s.mult}`).join("\n");
  }
  function parseSpecies(text) {
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    const out = [];
    for (const line of lines) {
      const [name, multRaw] = line.split(",").map(x=>x.trim());
      const mult = Number(multRaw);
      if (!name || !Number.isFinite(mult)) continue;
      out.push({ name, mult });
    }
    return out.length ? out : defaultSpecies;
  }

  function getPlayer(name) {
    return state.players.find(p => p.name === name) || state.players[0];
  }

  function baseTicketsBySize(cm) {
    const rules = state.rules.slice().sort((a,b)=>a.cm-b.cm);
    let base = 0;
    for (const r of rules) if (cm >= r.cm) base = r.tickets;
    return base;
  }

  function calcTickets({cm, whoName, speciesName, isFirstCatch, funnyBonus=false, manualTickets=null}) {
    const parts = [];
    if (manualTickets != null) {
      parts.push(`æ‰‹å‹•:${manualTickets}`);
      return { total: manualTickets, breakdown: parts.join(" / ") };
    }

    const base = (cm != null) ? baseTicketsBySize(cm) : 0;
    parts.push(`åŸºæº–:${base}`);

    const sp = state.species.find(s => s.name === speciesName) || state.species[0];
    const mult = sp?.mult ?? 1.0;

    // size-based only; if base is 0, keep 0 even if mult > 1
    let afterMult = base > 0 ? Math.round(base * mult) : 0;
    parts.push(`å€ç‡:${mult}â†’${afterMult}`);

    let bonus = 0;

    if (state.bonusFirst && isFirstCatch) { bonus += 1; parts.push("å…ˆåˆ¶+1"); }

    if (state.bonusGirl) {
      const pl = getPlayer(whoName);
      if (pl.gender === "f") { bonus += 1; parts.push("å¥³æ€§+1"); }
    }

    if (state.bonusFunny && funnyBonus) { bonus += 1; parts.push("å¤–é“+1"); }

    const total = afterMult + bonus;
    return { total, breakdown: parts.join(" / ") };
  }

  // ---- UI refs ----
  const whoEl = document.getElementById("who");
  const cmEl = document.getElementById("cm");
  const speciesEl = document.getElementById("species");
  const memoEl = document.getElementById("memo");

  const bonusFirstEl = document.getElementById("bonusFirst");
  const bonusGirlEl = document.getElementById("bonusGirl");
  const bonusFunnyEl = document.getElementById("bonusFunny");

  const scoreGridEl = document.getElementById("scoreGrid");
  const logEl = document.getElementById("log");

  const playersEl = document.getElementById("players");
  const rulesEl = document.getElementById("rules");
  const speciesRulesEl = document.getElementById("speciesRules");

  // Dialog
  const dlg = document.getElementById("dlg");
  const dlgTitle = document.getElementById("dlgTitle");
  const dlgContent = document.getElementById("dlgContent");
  const dlgActions = document.getElementById("dlgActions");

  function openDialog(title, contentHtml, actions) {
    dlgTitle.textContent = title;
    dlgContent.innerHTML = contentHtml;
    dlgActions.innerHTML = "";
    for (const a of actions) dlgActions.appendChild(a);
    dlg.showModal();
  }
  function btn(text, className, onClick) {
    const b = document.createElement("button");
    b.className = "btn " + (className || "");
    b.textContent = text;
    b.addEventListener("click", onClick);
    return b;
  }

  // ---- Renderers ----
  function refreshSelects() {
    // players
    whoEl.innerHTML = "";
    for (const p of state.players) {
      const opt = document.createElement("option");
      opt.value = p.name;
      opt.textContent = p.name + (p.gender === "f" ? "ï¼ˆå¥³æ€§ï¼‰" : "");
      whoEl.appendChild(opt);
    }
    // species
    speciesEl.innerHTML = "";
    for (const s of state.species) {
      const opt = document.createElement("option");
      opt.value = s.name;
      opt.textContent = `${s.name}ï¼ˆÃ—${s.mult}ï¼‰`;
      speciesEl.appendChild(opt);
    }
  }

  function renderScoreboard() {
    // totals per player
    const totals = {};
    const counts = {};
    let maxCm = null;
    for (const p of state.players) { totals[p.name] = 0; counts[p.name] = 0; }
    for (const e of state.log) {
      totals[e.whoName] = (totals[e.whoName] || 0) + e.tickets;
      counts[e.whoName] = (counts[e.whoName] || 0) + 1;
      if (typeof e.cm === "number" && Number.isFinite(e.cm)) maxCm = (maxCm==null)? e.cm : Math.max(maxCm, e.cm);
    }

    scoreGridEl.innerHTML = "";
    const playersSorted = state.players.slice().sort((a,b)=> (totals[b.name]||0) - (totals[a.name]||0));
    for (const p of playersSorted) {
      const div = document.createElement("div");
      div.innerHTML = `
        <div class="muted">${escapeHtml(p.name)} åˆè¨ˆæšæ•°</div>
        <div class="big">${totals[p.name] || 0}</div>
        <div class="muted">åŒ¹æ•°ï¼š${counts[p.name] || 0}</div>
      `;
      scoreGridEl.appendChild(div);
    }

    // global stats
    const g1 = document.createElement("div");
    g1.innerHTML = `<div class="muted">åˆè¨ˆåŒ¹æ•°</div><div class="big">${state.log.length}</div>`;
    const g2 = document.createElement("div");
    g2.innerHTML = `<div class="muted">æœ€å¤§ã‚µã‚¤ã‚º</div><div class="big">${maxCm==null ? "-" : (maxCm.toFixed(1)+"cm")}</div>`;
    scoreGridEl.appendChild(g1);
    scoreGridEl.appendChild(g2);
  }

  function renderLog() {
    logEl.innerHTML = "";
    const reversed = state.log.slice().reverse();
    reversed.forEach((e, idxFromTop) => {
      const idx = state.log.length - 1 - idxFromTop; // original index
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(e.time)}</td>
        <td>${escapeHtml(e.whoName)}</td>
        <td>${e.cm == null ? "-" : escapeHtml(e.cm.toFixed(1)) + "cm"}</td>
        <td>${escapeHtml(e.speciesName || "-")}</td>
        <td>${escapeHtml(e.memo || "")}</td>
        <td><b>${e.tickets}</b>æš</td>
        <td class="muted">${escapeHtml(e.breakdown || "")}</td>
        <td class="right"><button class="btn sub" data-edit="${idx}">âœï¸</button></td>
      `;
      logEl.appendChild(tr);
    });

    // bind edit buttons
    logEl.querySelectorAll("button[data-edit]").forEach(b => {
      b.addEventListener("click", () => openEditDialog(Number(b.getAttribute("data-edit"))));
    });
  }

  function recomputeAll() {
    refreshSelects();
    renderScoreboard();
    renderLog();
  }

  // ---- Actions ----
  function addEntry({whoName, cm, speciesName, memo, funnyBonus=false, manualTickets=null}) {
    const isFirstCatch = state.log.length === 0;
    const { total, breakdown } = calcTickets({cm, whoName, speciesName, isFirstCatch, funnyBonus, manualTickets});

    if (total <= 0) {
      alert("ãƒ«ãƒ¼ãƒ«æœªæº€ï¼ˆ0æšï¼‰ã£ã½ã„ï¼ã‚µã‚¤ã‚ºæ¡ä»¶ã‚„å€ç‡ã‚’è¦‹ç›´ã™ã‹ã€æ‰‹å‹•åŠ ç®—ã‚’ä½¿ã£ã¦ã­ã€‚");
      return;
    }
    state.log.push({
      id: crypto?.randomUUID?.() || String(Date.now()) + "_" + Math.random().toString(16).slice(2),
      time: nowText(),
      whoName,
      cm: (cm == null ? null : Math.round(cm * 10) / 10),
      speciesName: speciesName || "æŒ‡å®šãªã—",
      memo: memo || "",
      tickets: total,
      breakdown
    });
    saveState();
    recomputeAll();
  }

  function openEditDialog(index) {
    const e = state.log[index];
    if (!e) return;

    const playerOptions = state.players.map(p => `<option value="${escapeHtml(p.name)}" ${p.name===e.whoName?"selected":""}>${escapeHtml(p.name)}</option>`).join("");
    const speciesOptions = state.species.map(s => `<option value="${escapeHtml(s.name)}" ${s.name===e.speciesName?"selected":""}>${escapeHtml(s.name)}</option>`).join("");

    openDialog(
      "å±¥æ­´ã‚’ç·¨é›†",
      `
      <div class="row">
        <div class="field">
          <label>èª°</label>
          <select id="edWho">${playerOptions}</select>
        </div>
        <div class="field">
          <label>ã‚µã‚¤ã‚ºï¼ˆcmï¼‰</label>
          <input id="edCm" type="number" inputmode="decimal" step="0.1" value="${e.cm==null?"":e.cm}" />
        </div>
        <div class="field">
          <label>é­šç¨®</label>
          <select id="edSpecies">${speciesOptions}</select>
        </div>
      </div>
      <div style="margin-top:10px;">
        <label>ãƒ¡ãƒ¢</label>
        <input id="edMemo" type="text" value="${escapeHtml(e.memo || "")}" />
      </div>
      <p class="muted" style="margin:10px 0 0;">â€»ç·¨é›†å¾Œã«æšæ•°ã¯å†è¨ˆç®—ã•ã‚Œã¾ã™ï¼ˆå…ˆåˆ¶åˆ¤å®šã¯å…ƒã®â€œæœ€åˆã®1ä»¶â€ã«ã®ã¿é©ç”¨ï¼‰ã€‚</p>
      `,
      [
        btn("ã‚­ãƒ£ãƒ³ã‚»ãƒ«","sub", ()=>dlg.close()),
        btn("å‰Šé™¤","danger", ()=>{
          state.log.splice(index, 1);
          saveState(); recomputeAll();
          dlg.close();
        }),
        btn("ä¿å­˜","", ()=>{
          const whoName = document.getElementById("edWho").value;
          const cmVal = document.getElementById("edCm").value.trim();
          const cm = cmVal ? Number(cmVal) : null;
          const speciesName = document.getElementById("edSpecies").value;
          const memo = document.getElementById("edMemo").value;

          // Recalc: "first catch" only for index 0
          const isFirstCatch = index === 0;
          const { total, breakdown } = calcTickets({cm, whoName, speciesName, isFirstCatch, funnyBonus:false, manualTickets:null});

          if (total <= 0) { alert("ã“ã®å†…å®¹ã ã¨0æšã«ãªã£ã¡ã‚ƒã†ï¼"); return; }

          state.log[index] = {
            ...state.log[index],
            whoName,
            cm: (cm == null ? null : Math.round(cm * 10) / 10),
            speciesName,
            memo,
            tickets: total,
            breakdown
          };
          saveState(); recomputeAll();
          dlg.close();
        }),
      ]
    );
  }

  function openManualAddDialog() {
    const playerOptions = state.players.map(p => `<option value="${escapeHtml(p.name)}">${escapeHtml(p.name)}</option>`).join("");
    openDialog(
      "æ‰‹å‹•ã§æšæ•°ã‚’åŠ ç®—",
      `
      <div class="row">
        <div class="field">
          <label>èª°</label>
          <select id="manWho">${playerOptions}</select>
        </div>
        <div class="field">
          <label>åŠ ç®—ã™ã‚‹æšæ•°</label>
          <input id="manTickets" type="number" inputmode="numeric" step="1" min="1" value="1" />
        </div>
        <div class="field" style="flex:2 1 240px;">
          <label>ç†ç”±ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
          <input id="manMemo" type="text" placeholder="ä¾‹ï¼šãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ã‚¿ã‚¤ãƒ  / è¦³å®¢ãƒœãƒ¼ãƒŠã‚¹ ãªã©" />
        </div>
      </div>
      `,
      [
        btn("ã‚­ãƒ£ãƒ³ã‚»ãƒ«","sub", ()=>dlg.close()),
        btn("åŠ ç®—","", ()=>{
          const whoName = document.getElementById("manWho").value;
          const t = Number(document.getElementById("manTickets").value);
          if (!Number.isFinite(t) || t <= 0) { alert("æšæ•°ã‚’å…¥ã‚Œã¦ã­"); return; }
          const memo = document.getElementById("manMemo").value.trim();
          addEntry({whoName, cm:null, speciesName:"æŒ‡å®šãªã—", memo: (memo ? `æ‰‹å‹•:${memo}` : "æ‰‹å‹•åŠ ç®—"), manualTickets: Math.round(t)});
          dlg.close();
        }),
      ]
    );
  }

  function openRouletteEditDialog() {
    const lines = (state.roulette || defaultRoulette).join("\n");
    openDialog(
      "ã”é£¯ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆç·¨é›†",
      `
      <label>1è¡Œ=1å€™è£œ</label>
      <textarea id="rouLines">${escapeHtml(lines)}</textarea>
      <p class="muted" style="margin:8px 0 0;">ä¾‹ï¼šç„¼è‚‰ / å¯¿å¸ / ãƒ©ãƒ¼ãƒ¡ãƒ³â€¦ï¼ˆæ—©å¦ƒå­ã•ã‚“ã®å¥½ããªåº—ã‚‚å…¥ã‚Œã‚‹ã¨å½“ãŸã‚Šç‡ãŒä¸ŠãŒã‚‹â€»è«¸èª¬ï¼‰</p>
      `,
      [
        btn("ã‚­ãƒ£ãƒ³ã‚»ãƒ«","sub", ()=>dlg.close()),
        btn("ä¿å­˜","", ()=>{
          const t = document.getElementById("rouLines").value.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
          state.roulette = t.length ? t : defaultRoulette;
          saveState();
          dlg.close();
          alert("ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆä¿å­˜OKï¼");
        })
      ]
    );
  }

  function spinRoulette() {
    const list = (state.roulette && state.roulette.length) ? state.roulette : defaultRoulette;
    const pick = list[Math.floor(Math.random() * list.length)];
    openDialog(
      "æœ¬æ—¥ã®ã”é£¯ã€æ±ºå®šï¼",
      `<p style="font-size:22px; font-weight:900; margin:6px 0 0;">${escapeHtml(pick)}</p>
       <p class="muted" style="margin:10px 0 0;">â€»ç•°è­°ç”³ç«‹ã¦ã¯ã€Œã‚‚ã†1å›ã€ã§å—ã‘ä»˜ã‘ã¾ã™ã€‚</p>`,
      [
        btn("é–‰ã˜ã‚‹","sub", ()=>dlg.close()),
        btn("ã‚‚ã†1å›","", ()=>{ dlg.close(); spinRoulette(); }),
      ]
    );
  }

  // ---- Bindings ----
  document.getElementById("addBtn").addEventListener("click", () => {
    const whoName = whoEl.value;
    const cm = Number(cmEl.value);
    if (!Number.isFinite(cm) || cm <= 0) { alert("ã‚µã‚¤ã‚ºï¼ˆcmï¼‰ã‚’å…¥åŠ›ã—ã¦ã­ï¼"); cmEl.focus(); return; }
    const speciesName = speciesEl.value;
    const memo = memoEl.value.trim();
    addEntry({whoName, cm, speciesName, memo});
    cmEl.value = ""; memoEl.value = "";
  });

  cmEl.addEventListener("keydown", (e) => { if (e.key === "Enter") document.getElementById("addBtn").click(); });

  document.getElementById("funnyBtn").addEventListener("click", () => {
    if (!state.bonusFunny) {
      alert("å¤–é“ãƒœãƒ¼ãƒŠã‚¹ãŒOFFã ã‚ˆï¼è¨­å®šã§ONã«ã—ã¦ã­ã€‚");
      return;
    }
    const whoName = whoEl.value;
    addEntry({whoName, cm: null, speciesName: "å¤–é“ï¼ˆãƒ•ã‚°/ã‚¨ã‚½ç­‰ï¼‰", memo: "ç¬‘ãˆãŸå¤–é“", funnyBonus: true});
  });

  document.getElementById("manualBtn").addEventListener("click", openManualAddDialog);

  document.getElementById("undoBtn").addEventListener("click", () => {
    if (!state.log.length) return;
    state.log.pop();
    saveState();
    recomputeAll();
  });

  document.getElementById("clearBtn").addEventListener("click", () => {
    if (!confirm("å…¨éƒ¨æ¶ˆã™ï¼Ÿï¼ˆæˆ»ã›ã¾ã›ã‚“ï¼‰")) return;
    state.log = [];
    saveState();
    recomputeAll();
  });

  document.getElementById("rouletteBtn").addEventListener("click", spinRoulette);
  document.getElementById("editRouletteBtn").addEventListener("click", openRouletteEditDialog);

  // toggles
  bonusFirstEl.checked = !!state.bonusFirst;
  bonusGirlEl.checked  = !!state.bonusGirl;
  bonusFunnyEl.checked = !!state.bonusFunny;

  bonusFirstEl.addEventListener("change", ()=>{ state.bonusFirst = bonusFirstEl.checked; saveState(); recomputeAll(); });
  bonusGirlEl.addEventListener("change",  ()=>{ state.bonusGirl  = bonusGirlEl.checked;  saveState(); recomputeAll(); });
  bonusFunnyEl.addEventListener("change", ()=>{ state.bonusFunny = bonusFunnyEl.checked; saveState(); recomputeAll(); });

  // settings textareas init
  playersEl.value = playersToText(state.players);
  rulesEl.value = rulesToText(state.rules);
  speciesRulesEl.value = speciesToText(state.species);

  document.getElementById("savePlayersBtn").addEventListener("click", () => {
    state.players = parsePlayers(playersEl.value);
    saveState(); recomputeAll();
    alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¿å­˜OKï¼");
  });
  document.getElementById("resetPlayersBtn").addEventListener("click", () => {
    state.players = defaultPlayers;
    playersEl.value = playersToText(state.players);
    saveState(); recomputeAll();
  });

  document.getElementById("saveRulesBtn").addEventListener("click", () => {
    state.rules = parseRules(rulesEl.value);
    rulesEl.value = rulesToText(state.rules);
    saveState(); recomputeAll();
    alert("ã‚µã‚¤ã‚ºãƒ«ãƒ¼ãƒ«ä¿å­˜OKï¼");
  });
  document.getElementById("resetRulesBtn").addEventListener("click", () => {
    state.rules = defaultRules;
    rulesEl.value = rulesToText(state.rules);
    saveState(); recomputeAll();
  });

  document.getElementById("saveSpeciesBtn").addEventListener("click", () => {
    state.species = parseSpecies(speciesRulesEl.value);
    // ensure "æŒ‡å®šãªã—" exists
    if (!state.species.find(s => s.name === "æŒ‡å®šãªã—")) state.species.unshift({name:"æŒ‡å®šãªã—", mult:1.0});
    speciesRulesEl.value = speciesToText(state.species);
    saveState(); recomputeAll();
    alert("å€ç‡ä¿å­˜OKï¼");
  });
  document.getElementById("resetSpeciesBtn").addEventListener("click", () => {
    state.species = defaultSpecies;
    speciesRulesEl.value = speciesToText(state.species);
    saveState(); recomputeAll();
  });

  // init
  recomputeAll();
</script>
</body>
</html>
